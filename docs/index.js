!function(){function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),superClass&&_setPrototypeOf(subClass,superClass)}function _getPrototypeOf(o){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)})(o)}function _setPrototypeOf(o,p){return(_setPrototypeOf=Object.setPrototypeOf||function(o,p){return o.__proto__=p,o})(o,p)}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function _construct(Parent,args,Class){return(_construct=_isNativeReflectConstruct()?Reflect.construct:function(Parent,args,Class){var a=[null];a.push.apply(a,args);var instance=new(Function.bind.apply(Parent,a));return Class&&_setPrototypeOf(instance,Class.prototype),instance}).apply(null,arguments)}function _assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}function _possibleConstructorReturn(self,call){return!call||"object"!=typeof call&&"function"!=typeof call?_assertThisInitialized(self):call}function _createSuper(Derived){return function(){var result,Super=_getPrototypeOf(Derived);if(_isNativeReflectConstruct()){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)}}function _superPropBase(object,property){for(;!Object.prototype.hasOwnProperty.call(object,property)&&null!==(object=_getPrototypeOf(object)););return object}function _get(target,property,receiver){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(target,property,receiver){var base=_superPropBase(target,property);if(base){var desc=Object.getOwnPropertyDescriptor(base,property);return desc.get?desc.get.call(receiver):desc.value}})(target,property,receiver||target)}function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_unsupportedIterableToArray(arr)||_nonIterableSpread()}function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}function _iterableToArray(iter){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(iter))return Array.from(iter)}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var Component=function(){function Component(onInit){_classCallCheck(this,Component),_defineProperty(this,"context",void 0),_defineProperty(this,"attr",void 0),_defineProperty(this,"watchers",[]),this.onInit=onInit}return _createClass(Component,[{key:"init",value:function(context,attr){var _this=this;this.context=context,this.attr=attr,this.onInit(),setTimeout((function(){_this.registerWatches(context),setInterval((function(){return _this.watchers.forEach((function(w){return w.call()}))}),20)}),0)}},{key:"onClick",value:function(selector,callback){var _this2=this;(this.context===selector?this.context:this.context.querySelectorAll(selector)).forEach((function(element,index){element.addEventListener("click",(function(event){callback.apply(_this2,[event,element,index])}))}))}},{key:"setInput",value:function(selector,value){this.context.querySelector(selector).value=value}},{key:"getInput",value:function(selector){return this.context.querySelector(selector).value}},{key:"setClass",value:function(selector,className,enable){this.context.querySelectorAll(selector).forEach((function(element){enable?element.classList.add(className):element.classList.remove(className)}))}},{key:"evalBinding",value:function evalBinding(binding){return eval(binding)}},{key:"watch",value:function(e,matches,scope){var _this3=this,watcher={e:e,matches:matches,scope:scope,call:function(){var val=_this3.evalBinding.apply(watcher.scope,[matches[2]]);watcher.oldVal!==val&&(watcher.e.textContent=matches[1]+val+matches[3]),watcher.oldVal=val}};this.watchers.push(watcher)}},{key:"searchTextNodes",value:function(context,self){var _this4=this;Array.from(context.childNodes||[]).forEach((function(n){var e=n;if(!e.getAttribute||e.getAttribute("parent")!==_this4.context.nodeName){if(3===e.nodeType&&e.nodeValue.trim()){var matches=/(.*){{(.+)}}(.*)/g.exec(e.nodeValue);matches&&_this4.watch(e,matches,self)}_this4.searchTextNodes(e,self)}}))}},{key:"registerWatches",value:function(context){var _this5=this,self=this;Array.from(context.childNodes||[]).forEach((function(n){var e=n;self.context&&e.getAttribute&&e.getAttribute("parent")!==self.context.nodeName&&(_this5.searchTextNodes(e,self),_this5.registerWatches(e))}))}}]),Component}(),Players={Yellow:{name:"Yellow",value:2},Red:{name:"Red",value:1}},PlayerArray=[Players.Red.name,Players.Yellow.name],DefaultGrid={rows:6,columns:7},GameActions={Move:"[Move] Player moves a piece",Win:"[Win] Player wins the game",Lose:"[Lose] Player loses the game"},Game=function(_Component){_inherits(Game,_Component);var _super=_createSuper(Game);function Game(gameService){var _this;return _classCallCheck(this,Game),_this=_super.call(this,(function(){_this.gameService=gameService,_this.thinking=!1,_this.winner="",_this.turnIndex=0,_this.players=PlayerArray,_this.gameId="",_this.board={onlinePlayerColor:null,playerGoingNext:_this.players[_this.turnIndex%2],onWinner:function(winner){_this.winner=winner,_get(_getPrototypeOf(Game.prototype),"setClass",_assertThisInitialized(_this)).call(_assertThisInitialized(_this),"#winner","hide",!1),_get(_getPrototypeOf(Game.prototype),"setClass",_assertThisInitialized(_this)).call(_assertThisInitialized(_this),"#turn","hide",!0),setTimeout((function(){_get(_getPrototypeOf(Game.prototype),"setClass",_assertThisInitialized(_this)).call(_assertThisInitialized(_this),".confetti","hide",!1)}),750)},onPieceClick:function(moveData){_this.togglePlayerGoingNext(),moveData.color===_this.board.onlinePlayerColor&&_this.gameService.sendMove(moveData,(function(){console.log("Player recieved action!")}))},scope:{}},_this.settings={onStartGame:function(_ref){var player=_ref.player,online=_ref.online;console.log("Starting game as ".concat(JSON.stringify(player)," :: online - ").concat(online)),_this.playerColor=online?player.name:_this.board.playerGoingNext,_this.board.onlinePlayerColor=online?player.name:null,_get(_getPrototypeOf(Game.prototype),"setClass",_assertThisInitialized(_this)).call(_assertThisInitialized(_this),"#game-settings","hide",!0),_get(_getPrototypeOf(Game.prototype),"setClass",_assertThisInitialized(_this)).call(_assertThisInitialized(_this),"#game-board","hide",!1)}},_this.gameService.retrieveMoves((function(moveData){_this.board.scope.movePiece(moveData)}))}))}return _createClass(Game,[{key:"togglePlayerGoingNext",value:function(){this.turnIndex++,this.board.playerGoingNext=this.players[this.turnIndex%2]}}]),Game}(Component);_defineProperty(Game,"services",["gameService"]),_defineProperty(Game,"selector","game"),_defineProperty(Game,"template","\n        ".concat(Array.from(Array(10)).map((function(){return'<div class="confetti hide"></div>'})).join(""),'\n        <div id="game-settings">\n            <settings options="{{this.settings}}"></settings>\n        </div>\n        <div id="game-board" class="hide">\n            <div class="info-bar">\n                <span id="turn" class="info-bar-item">\n                    <span class="bold">\n                        {{this.board.playerGoingNext + \'s turn\'}}\n                    </span>\n                </span>\n                <span id="winner" class="hide info-bar-item">\n                    <span class="bold">{{this.winner + \' won!\'}}</span>\n                </span>\n            </div>\n            <board options="{{this.board}}"></board>\n        </div>\n    '));var BoardService=function(){function BoardService(){var _this=this,numberOfRows=arguments.length>0&&void 0!==arguments[0]?arguments[0]:6,numberOfColumns=arguments.length>1&&void 0!==arguments[1]?arguments[1]:7;_classCallCheck(this,BoardService),this.grid=Array.from(Array(numberOfRows).keys()).map((function(){return Array.from(Array(numberOfColumns).keys()).map((function(){return 0}))}));var horizontal=function(){return _this._checkLineStrategy({size:3},{size:7},(function(x,y){return[{x:x,y:y},{x:x+1,y:y},{x:x+2,y:y},{x:x+3,y:y}]}))},vertical=function(){return _this._checkLineStrategy({size:6},{size:4},(function(x,y){return[{x:x,y:y},{x:x,y:y+1},{x:x,y:y+2},{x:x,y:y+3}]}))},diagonalRight=function(){return _this._checkLineStrategy({size:3},{size:4},(function(x,y){return[{x:x,y:y},{x:x+1,y:y+1},{x:x+2,y:y+2},{x:x+3,y:y+3}]}))},diagonalLeft=function(){return _this._checkLineStrategy({initial:3,size:6},{size:4},(function(x,y){return[{x:x,y:y},{x:x-1,y:y+1},{x:x-2,y:y+2},{x:x-3,y:y+3}]}))};this.winnerStrategies=[horizontal,vertical,diagonalLeft,diagonalRight]}return _createClass(BoardService,[{key:"determineAvailableRowSpot",value:function(col){for(var i=this.grid.length-1;i>=0;i--)if(!this.grid[i][col])return i}},{key:"claimSpot",value:function(col,color){var row=this.determineAvailableRowSpot(col);if(void 0!==row){this.grid[row][col]=color===Players.Red.name?Players.Red.value:Players.Yellow.value;var moveData=this.hasWinner();return{row:row,col:col,color:color,isWinner:Boolean(moveData.player),winningPieces:moveData.winningPieces}}}},{key:"_checkLineStrategy",value:function(row,col,onGetLine){for(var r=row.initial||0;r<row.size;r++)for(var c=col.initial||0;c<col.size;c++){var line=onGetLine(r,c);if(0!==this.grid[line[0].x][line[0].y]&&this.grid[line[0].x][line[0].y]===this.grid[line[1].x][line[1].y]&&this.grid[line[0].x][line[0].y]===this.grid[line[2].x][line[2].y]&&this.grid[line[0].x][line[0].y]===this.grid[line[3].x][line[3].y])return line}return[]}},{key:"hasWinner",value:function(){for(var line=[],i=0;i<this.winnerStrategies.length;i++)if((line=this.winnerStrategies[i]()).length)return{winningPieces:line,player:PlayerArray[this.grid[line[0].x][line[0].y]-1]};return{winningPieces:[],player:null}}}]),BoardService}();function getColumn(index){return'\n        <div class="board-column" id="boardColumn'.concat(index,'">\n            ').concat(Array.from(Array(DefaultGrid.rows).keys()).map((function(a,i){return'\n                    <piece id="piece'.concat(i,"Row").concat(index,'" options={{this.options}}></piece>\n            ')})).join(""),"\n        </div>")}var Board=function(_Component){_inherits(Board,_Component);var _super=_createSuper(Board);function Board(){var _this;return _classCallCheck(this,Board),_this=_super.call(this,(function(){_this.service=new BoardService(DefaultGrid.rows,DefaultGrid.columns),_get(_getPrototypeOf(Board.prototype),"onClick",_assertThisInitialized(_this)).call(_assertThisInitialized(_this),".board-column",(function(event,columnElement,columnIndex){var color=_this.options.board.playerGoingNext;if(_this.isMoveAllowed(event,color)){var playerMove=_this.service.claimSpot(columnIndex,color);playerMove&&(columnElement.querySelectorAll("button")[playerMove.row].click(),_this.options.board.onPieceClick({columnIndex:columnIndex,color:color}),_this.isWinner=playerMove.isWinner,playerMove.isWinner&&_this.options.board.onWinner(color))}})),_this.options={board:_this.attr.options},_this.attr.options.scope.movePiece=function(moveData){Array.from(_this.context.querySelectorAll(".board-column"))[moveData.columnIndex].click(moveData)}}))}return _createClass(Board,[{key:"isMoveAllowed",value:function(event,color){return!(this.isWinner||this.attr.options.onlinePlayerColor&&event.isTrusted&&this.attr.options.onlinePlayerColor!==color)}}]),Board}(Component);_defineProperty(Board,"selector","board"),_defineProperty(Board,"template",'\n        <div class="board-container">\n            '.concat(Array.from(Array(DefaultGrid.columns).keys()).map((function(a,i){return getColumn(i)})).join(""),"\n        </div>"));var Piece=function(_Component){_inherits(Piece,_Component);var _super=_createSuper(Piece);function Piece(){var _this;return _classCallCheck(this,Piece),_this=_super.call(this,(function(){_this.pieceColor="default",_get(_getPrototypeOf(Piece.prototype),"onClick",_assertThisInitialized(_this)).call(_assertThisInitialized(_this),".slot button",(function(event,element){if(!_this.playerHasClaimed){var slot=element.parentElement;slot.classList.remove(_this.pieceColor),slot.classList.add(_this.attr.options.board.playerGoingNext),_this.pieceColor=_this.attr.options.board.playerGoingNext,_this.playerHasClaimed=!0,event.stopImmediatePropagation()}}))}))}return Piece}(Component);_defineProperty(Piece,"selector","piece"),_defineProperty(Piece,"template",'\n    <div class="slot-container">\n        <div class="slot default">\n            <button style="display:none"></button>\n        </div>\n    <div>');var Injector={map:{},service:function(_service,name){return this.map[name]=_service,this},get:function(name){return this.map[name]}},componentMap={};function camelCase(attribute){return attribute.nodeName.split("-").map((function(name,i){return i?name[0].toUpperCase()+name.slice(1):name})).join("")}var Engine=function(){function Engine(context){var components=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],services=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};_classCallCheck(this,Engine),components.forEach((function(c){componentMap[c.selector.toLowerCase()]={template:c.template,services:c.services||[],constructor:c}})),Object.keys(services).forEach((function(service){return Injector.service(services[service],service)})),this.render(context)}return _createClass(Engine,[{key:"render",value:function(context){var parent=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,parentContext=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,self=this,nodes=(context||{childNodes:[]}).childNodes||[];Array.from(nodes).forEach((function(e){var newParent=parent,newParentContext=parentContext,nodeName=e.nodeName.toLowerCase();if(componentMap[nodeName]){newParent=nodeName;var attr={};parentContext&&Array.from(e.attributes).forEach((function(a){var name=camelCase(a);attr[name]=parentContext.evalBinding.apply(parentContext,[a.value])})),parent&&e.setAttribute("parent",parent),e.innerHTML=componentMap[nodeName].template;var services=componentMap[nodeName].services.map((function(s){return Injector.get(s)}));(newParentContext=_construct(componentMap[nodeName].constructor,_toConsumableArray(services))).init(e,attr)}self.render(e,newParent,newParentContext)}))}}]),Engine}(),GameService=function(){function GameService(onlineBroker){_classCallCheck(this,GameService),this.onlineBroker=onlineBroker}return _createClass(GameService,[{key:"creatSession",value:function(onGameId,onConnected){this.onlineBroker.creatSession(onGameId,(function(){onConnected()}))}},{key:"connectSession",value:function(gameId,onConnected){this.onlineBroker.connectSession(gameId,(function(){onConnected()}))}},{key:"retrieveMoves",value:function(onRetrieve){this.onlineBroker.subscribe(GameActions.Move,onRetrieve)}},{key:"sendMove",value:function(moveData,onRetrieve){this.onlineBroker.send(GameActions.Move,moveData,onRetrieve)}}]),GameService}(),RETRIEVED_TAG=" ::Retrieved::";function initialize(){var peer=new Peer("",{debug:2});return peer.on("open",(function(id){console.log(id)})),peer.on("error",(function(err){console.log(err)})),function ping(){peer.socket.send({type:"ping"}),setTimeout(ping,16e3)}(),peer}function listen(client,subscriberMap){client.on("data",(function(response){var parsed=JSON.parse(response);if(!parsed.action.includes(RETRIEVED_TAG)){var subscribers=subscriberMap[parsed.action];subscribers&&subscribers.length&&subscribers.forEach((function(s){return s.onAction(parsed.data)})),client.send(JSON.stringify({action:parsed.action+RETRIEVED_TAG,data:{}}))}}))}var OnlineBroker=function(){function OnlineBroker(){_classCallCheck(this,OnlineBroker),this.subscriberMap={}}return _createClass(OnlineBroker,[{key:"creatSession",value:function(onGameId,onConnected){var _this=this;this.peer=initialize(),this.peer.on("open",(function(gameId){console.log("Connection opened for player A"),onGameId(gameId),_this.peer.on("connection",(function(client){_this.client=client,listen(_this.client,_this.subscriberMap),onConnected()}))}))}},{key:"connectSession",value:function(gameId,onConnected){var _this2=this;this.peer=initialize(),this.client&&this.client.close(),this.peer.on("open",(function(){console.log("Connection opened for player B"),_this2.client=_this2.peer.connect(gameId,{reliable:!0}),_this2.client.on("open",(function(){console.log("Connected to "+_this2.client.peer),listen(_this2.client,_this2.subscriberMap),onConnected()}))}))}},{key:"send",value:function(action,data,onRetrieved){var _this3=this;this.client.send(JSON.stringify({action:action,data:data}));this.client.on("data",(function callback(response){JSON.parse(response).action===action+RETRIEVED_TAG&&(onRetrieved(!0),_this3.client.off("data",callback))}))}},{key:"subscribe",value:function(action,onAction){var subscribers=this.subscriberMap[action];subscribers||(subscribers=[]),subscribers.push({onAction:onAction}),this.subscriberMap[action]=subscribers}}]),OnlineBroker}(),Settings=function(_Component){_inherits(Settings,_Component);var _super=_createSuper(Settings);function Settings(gameService){var _this;return _classCallCheck(this,Settings),_this=_super.call(this,(function(){if(_this.gameService=gameService,_this.shareUrl="",_this.urlParams=new URLSearchParams(window.location.search),_this.urlParams.has("session")){var gameId=_this.urlParams.get("session");_this.gameService.connectSession(gameId,(function(){return _this.attr.options.onStartGame({player:Players.Yellow,online:!0})}))}_get(_getPrototypeOf(Settings.prototype),"onClick",_assertThisInitialized(_this)).call(_assertThisInitialized(_this),"#online-mode",(function(){_get(_getPrototypeOf(Settings.prototype),"setClass",_assertThisInitialized(_this)).call(_assertThisInitialized(_this),"#online-options","hide",!1),_this.loader="Generating game session url...",_this.gameService.creatSession((function(gameId){return _this.onGameId(gameId)}),(function(){return _this.attr.options.onStartGame({player:Players.Red,online:!0})}))})),_get(_getPrototypeOf(Settings.prototype),"onClick",_assertThisInitialized(_this)).call(_assertThisInitialized(_this),"#offline-mode",(function(){_get(_getPrototypeOf(Settings.prototype),"setClass",_assertThisInitialized(_this)).call(_assertThisInitialized(_this),"#online-options","hide",!0),_this.attr.options.onStartGame({player:null,online:!1})}))}))}return _createClass(Settings,[{key:"onGameId",value:function(gameId){_get(_getPrototypeOf(Settings.prototype),"setClass",this).call(this,"#share-url","hide",!1),_get(_getPrototypeOf(Settings.prototype),"setInput",this).call(this,"#share-url",window.location.href+"?session="+gameId),this.loader="Share this url with your opponent. Please wait while your opponent enters the game."}}]),Settings}(Component);_defineProperty(Settings,"services",["gameService"]),_defineProperty(Settings,"selector","settings"),_defineProperty(Settings,"template",'\n        <div class="settings-menu">\n            <div class="settings-header">Connect 4</div>\n            <div class="settings-options">\n                <div class="option">\n                    <div>\n                        <div class="settings-options-title">Mode</div>\n                        <div>\n                            <input type="radio" name="mode" id="online-mode"><label for="online-mode">Online</label>\n                            <input type="radio" name="mode" id="offline-mode"><label for="offline-mode">Offline</label>\n                        </div>\n                    </div>\n                    <br/>\n                    <div id="online-options" class="hide">\n                        <div class="settings-options-title">Online Session</div>\n                        <div>\n                            <div class="caption-text">{{this.loader}}<div>\n                            <input id="share-url" onclick="this.select()" class="hide share-url">\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    ');var components=[Game,Board,Piece,Settings],onlineBroker=new OnlineBroker,gameService=new GameService(onlineBroker),services={gameService:gameService},app=new Engine(document.getElementById("main"),components,services);app.render()}();